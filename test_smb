# AD 모듈이 있으면 사용, 없으면 LDAP 대체
if (Get-Module -ListAvailable ActiveDirectory) {
  Import-Module ActiveDirectory
  $targets = (Get-ADComputer -Filter * -Properties DNSHostName).DNSHostName | ? { $_ }
} else {
  # LDAP로 도메인 조인 컴퓨터 FQDN 수집
  $rootDN = ([ADSI]"LDAP://RootDSE").defaultNamingContext
  $searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]"LDAP://$rootDN")
  $searcher.PageSize = 1000
  $searcher.Filter = "(objectCategory=computer)"
  $null = $searcher.PropertiesToLoad.Add("dNSHostName")
  $null = $searcher.PropertiesToLoad.Add("name")
  $res = $searcher.FindAll()

  # dNSHostName 없으면 name+도메인으로 보정
  $domainDns = ($rootDN -replace 'DC=','' -replace ',','.')
  $targets = @()
  foreach ($r in $res) {
    $dns = $r.Properties["dnshostname"]
    if ($dns -and $dns[0]) {
      $targets += $dns[0]
    } else {
      $name = $r.Properties["name"]
      if ($name -and $name[0]) { $targets += "$($name[0]).$domainDns" }
    }
  }
  $targets = $targets | ? { $_ } | Sort-Object -Unique
}

$results = foreach ($h in $targets) {
  if (-not (Test-NetConnection $h -Port 445 -InformationLevel Quiet)) { continue }

  # 현재 계정으로 공유 나열
  $shareLines = (& cmd /c "net view \\$h" 2>$null)
  $shares = $shareLines | ? { $_ -match '^\s+\S+' } | % { ($_ -split '\s+')[0] } | ? { $_ -and $_ -ne 'IPC$' }

  # Null Session 연결 시도
  & cmd /c "net use \\$h\IPC$ "" /user:"""" /persistent:no" 2>$null | Out-Null
  $anonOK = ($LASTEXITCODE -eq 0)

  foreach ($s in $shares) {
    $path = "\\$h\$s"
    $curList = Test-Path $path
    $anonList = $null
    if ($anonOK) { $anonList = Test-Path $path }

    [pscustomobject]@{
      Host            = $h
      Share           = $s
      List_CurrentUser= $curList
      List_Anonymous  = $anonList
    }
  }

  if ($anonOK) { & cmd /c "net use \\$h\IPC$ /delete /y" | Out-Null }
}

$results | Sort-Object Host, Share | Format-Table -AutoSize
# CSV로 저장하려면:
# $results | Export-Csv smb_results.csv -NoTypeInformation -Encoding UTF8
